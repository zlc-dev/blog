---
import type { SupportedLanguages } from '../i18n_config.ts';


interface Props {
    data_repo: string;
    data_repo_id: string;
    data_category: string;
    data_category_id: string;
    theme_path: string;
    locale: SupportedLanguages
};

const {
    data_repo,
    data_repo_id,
    data_category,
    data_category_id,
    theme_path,
    locale
} = Astro.props;

function format_locale(locale: SupportedLanguages): string {
    let l = locale.split('-', 2);
    if (l.length < 2) return locale;
    return `${l[0]}-${l[1].toUpperCase()}`;
}

---

<astro-giscus
    data-repo={data_repo}
    data-repo-id={data_repo_id}
    data-category={data_category}
    data-category-id={data_category_id}
    data-theme={theme_path}
    data-lang={format_locale(locale)}
></astro-giscus>

<script>
import { getTheme } from "../theme";

class AstroGiscus extends HTMLElement {
    constructor() {
        super();
    }

    connectedCallback() {
        this.renderGiscus();
    }

    disconnectedCallback() {
    }

    handleThemeUpdate() {
        const iframe = this.querySelector<HTMLIFrameElement>("iframe.giscus-frame");
        if (!iframe) return;

        const theme = getTheme();
        const origin = new URL(iframe.src).origin;

        iframe.contentWindow?.postMessage(
            { giscus: { setConfig: { theme } } },
            origin
        );
    }

    renderGiscus() {
        this.innerHTML = "";
        const script = document.createElement("script");
        script.src = "https://giscus.app/client.js";
        script.async = true;
        script.crossOrigin = "anonymous";

        script.setAttribute("data-repo", this.dataset.repo ?? "");
        script.setAttribute("data-repo-id", this.dataset.repoId ?? "");
        script.setAttribute("data-category", this.dataset.category ?? "");
        script.setAttribute("data-category-id", this.dataset.categoryId ?? "");
        script.setAttribute("data-mapping", "og:title");
        script.setAttribute("data-reactions-enabled", "1");
        script.setAttribute("data-input-position", "top");
        script.setAttribute("data-theme", getTheme() ?? "");
        script.setAttribute("data-lang", this.dataset.lang ?? "");
        script.setAttribute("data-loading", "lazy");

        this.appendChild(script);
    }
}

let giscus = document.querySelectorAll<AstroGiscus>("astro-giscus");
document.addEventListener("astro:page-load", () => {
    giscus = document.querySelectorAll("astro-giscus");
    giscus?.forEach(e => e.renderGiscus());
});

document.addEventListener("giscus:theme-update", () => {
    giscus?.forEach(e => e.handleThemeUpdate());
});

customElements.define("astro-giscus", AstroGiscus);

</script>
